name: Build Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          6.0.x
          8.0.x
        
    - name: Restore dependencies
      run: dotnet restore --verbosity normal
      
    - name: Build
      run: dotnet build --configuration Release --no-restore --verbosity normal
      
    - name: Test build output
      run: |
        echo "Checking build output..."
        ls -la bin/Release/
        ls -la bin/Release/netstandard2.0/ || echo "netstandard2.0 directory not found"
        find . -name "*.dll" -path "*/Release/*" | head -10
        
    - name: Create plugin directory structure
      run: |
        mkdir -p plugin/TubeArchivistMetadata
        
    - name: Copy plugin files
      run: |
        # Find the DLL file and copy it
        find . -name "Emby.Plugin.TubeArchivistMetadata.dll" -path "*/Release/*" -exec cp {} plugin/TubeArchivistMetadata/ \;
        # Verify the file was copied
        if [ ! -f "plugin/TubeArchivistMetadata/Emby.Plugin.TubeArchivistMetadata.dll" ]; then
          echo "Error: DLL file not found or copied"
          exit 1
        fi
        # Copy meta.json
        cp meta.json plugin/TubeArchivistMetadata/
        
    - name: Verify plugin files
      run: |
        echo "Plugin directory contents:"
        ls -la plugin/TubeArchivistMetadata/
        
    - name: Create plugin zip
      run: |
        cd plugin
        zip -r ../TubeArchivistMetadata.zip TubeArchivistMetadata/
        cd ..
        echo "Created zip file:"
        ls -la TubeArchivistMetadata.zip
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: plugin-build
        path: |
          plugin/TubeArchivistMetadata/Emby.Plugin.TubeArchivistMetadata.dll
          plugin/TubeArchivistMetadata/meta.json
          TubeArchivistMetadata.zip
        retention-days: 30
        
    - name: Upload to release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: TubeArchivistMetadata.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
